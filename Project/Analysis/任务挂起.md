##### 任务挂起

**功能实现：**

* 从就绪链表中转移到挂起链表，调用恢复后从挂起链表转移到就绪链表

**步骤分析：**

对系统时基自增中断的影响：挂起恢复单个任务不影响

一：任务挂起考虑

1. 任务状态可以是运行中，就绪态，延时阻塞态
2. 任务从就绪链表中移除影响到最高就绪优先级
3. 任务从阻塞链表中移除影响到最近到期任务时基
4. 当前任务的挂起，要考虑切换任务

二：任务恢复需要考虑：

1. 任务从挂起链表中移除
2. 任务挂起后恢复只能回到就绪态，需要考虑恢复到就绪链表后的最高就绪优先级
3. 恢复到就绪态，需要考虑任务是否切换

**逻辑代码：**

```c
void vTaskSuspend( TaskHandle_t xTaskToSuspend ){
	开启临界段；
	通过句柄获取TCB（句柄等于NULL则为当前任务）；
	将任务从原链表中删除，如果为空
	调用宏：{
		if( 判断该TCB的所属优先级的就绪链表中有没有节点 )
			没有节点则清空当前优先级位变量
	}
	将任务插入挂起链表；
	关闭临界段；
	if( 调度器在运行中 ) {
		开启临界段；
		fun { 更新最新任务到期的时基
			if( 阻塞延时链表节点数为空 )
				最新延时任务到期时基赋最大值；
			else
				去延时链表里取出头节点，将到期时基赋值给最新任务到期时基变量
		}
		关闭临界段；
	}
	if( TCB==pxCurrentTCB ){
		if( 调度器工作 ) {
			调用切换任务的宏：{
				portYIELD_WITHIN_API();
			}		
		} else {
			//1.创建第一个任务就把自己挂起，这时候pxCurrentTCB要赋值NULL
			if( 创建任务计数器 == 挂起任务个数 ){
				pxCurrentTCB = NULL;
			} else {
			//2.创建非第一个任务把自己挂起，这时候寻找最高优先级的任务，赋值给pxCurrentTCB
				fun：vTaskSwitchContext();
			}
		}
	}
}
BaseType_t xTaskResume( TaskHandle_t xTaskToResume ){
    if( TCB!=NULL && TCB!=pxCurrentTCB ){
    	开启临界段；
        确保任务在挂起链表中：fun{
            if( TCB->Item->所属链表 == 挂起链表 ){
				从挂起链表中移除；
                加入就绪链表宏：{
                    最高优先级位变量对应位置位；
                    插入就绪链表；
                }
                if( 恢复的TCB优先级 >= pxCurrentTCB优先级 ){
                    调用切换任务的宏：{
                        portYIELD_WITHIN_API();
                    }
                } 
            }
        }
        关闭临界段；  
    }
}
```



##### 挂起、恢复所有任务：

**功能实现：**

1. 挂起所有会锁住系统时基自增，为了恢复后时基也能恢复，用uxPendedTicks替代系统时机自增
2. 挂起所有会锁住上下文切换，如果有上下文切换，将记录在延迟调度变量xYieldPending = pdTRUE;

**恢复所有任务：**

​	1.解除一层

​	2.将所有挂起的任务恢复到就绪链表

​	3.通过变量xYieldPending表示有任务需要调度

​	4.通过延迟时基自增uxPendedTicks，调用让时基自增执行次数=uxPendedTicks

​	5.通过变量xYieldPending表示有任务待调度，若有则执行任务调度

**代码：**

```c
//对系统时基自增的影响
BaseType_t xTaskIncrementTick( void ) {
    if( uxSchedulerSuspended == pdFALSE ) {
        ...
    } else {
        uxPendedTicks++;
    }
}
//对上下文切换的影响
void vTaskSwitchContext( void ) {  
    if( uxSchedulerSuspended != pdFALSE ){
        xYieldPending = pdTRUE;
    } else {
        xYieldPending = pdFALSE;
        ...
    }
}

void vTaskSuspendAll( void ) {
	++uxSchedulerSuspended;
}
BaseType_t xTaskResumeAll( void ) {
    1.uxSchedulerSuspended--;
    if( uxSchedulerSuspended == 0 ){
        while( 挂起链表节点数>0 ){
            挂起首节点取出TCB；
            uxListRemove(TCB节点);
            宏{ 将任务添加进就绪链表 }
            if( 存在就绪任务优先级>=当前任务优先级 )
                xYieldPending = pdTRUE;
        }
        while(uxPendedTicks--){
            if( xTaskIncrementTick() != pdFALSE ) {
                xYieldPending = pdTRUE;
            }
        }
        if( xYieldPending ) {
            宏{ 任务调度 }
        }
    }
}
```



